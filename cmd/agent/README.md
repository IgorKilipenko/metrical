# cmd/agent

–í –¥–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –∫–æ–¥ **–ê–≥–µ–Ω—Ç–∞ –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫**, –∫–æ—Ç–æ—Ä—ã–π –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –≤ –±–∏–Ω–∞—Ä–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

## üìä –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

–ê–≥–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç runtime –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ Go –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ HTTP.

### üîÑ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä 29+ –º–µ—Ç—Ä–∏–∫ –∏–∑ `runtime.MemStats`
- **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞** - –æ—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç—Ä–∏–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
- **Graceful shutdown** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
- **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `sync.RWMutex` –¥–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

### üìà –°–æ–±–∏—Ä–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏

#### Runtime –º–µ—Ç—Ä–∏–∫–∏ (Gauge):
- `Alloc` - —Ç–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- `HeapAlloc` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ heap –ø–∞–º—è—Ç–∏
- `HeapIdle` - —Å–≤–æ–±–æ–¥–Ω–∞—è heap –ø–∞–º—è—Ç—å
- `HeapInuse` - –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è heap –ø–∞–º—è—Ç—å
- `NumGC` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–±–æ—Ä–æ–∫ –º—É—Å–æ—Ä–∞
- `GCCPUFraction` - –¥–æ–ª—è CPU –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ GC
- `PauseTotalNs` - –æ–±—â–µ–µ –≤—Ä–µ–º—è –ø–∞—É–∑ GC
- `Mallocs` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–ª–ª–æ–∫–∞—Ü–∏–π
- `Frees` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–π
- `TotalAlloc` - –æ–±—â–∏–π –æ–±—ä–µ–º –∞–ª–ª–æ–∫–∞—Ü–∏–π
- –ò –µ—â–µ 17 –º–µ—Ç—Ä–∏–∫ –∏–∑ `runtime.MemStats`

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- `RandomValue` (gauge) - —Å–ª—É—á–∞–π–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0 –¥–æ 1
- `PollCount` (counter) - —Å—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –º–µ—Ç—Ä–∏–∫

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```go
type Config struct {
    ServerURL      string        // URL —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: http://localhost:8080)
    PollInterval   time.Duration // –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2s)
    ReportInterval time.Duration // –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ—Ç—Ä–∏–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10s)
}
```

## üöÄ –ó–∞–ø—É—Å–∫

```bash
# –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞
go run cmd/agent/main.go

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è –≤ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª
go build -o agent cmd/agent/main.go
./agent
```

## üõë Graceful Shutdown

–ê–≥–µ–Ω—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Ctrl+C
^C
2025/08/03 09:12:40 Received signal: terminated
2025/08/03 09:12:40 Stopping agent...
2025/08/03 09:12:40 Agent stopped gracefully
2025/08/03 09:12:40 Polling stopped
2025/08/03 09:12:40 Reporting stopped
2025/08/03 09:12:41 Agent shutdown completed
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –¢–µ—Å—Ç—ã –∞–≥–µ–Ω—Ç–∞
go test ./internal/agent/... -v

# –ó–∞–ø—É—Å–∫ —Å —Ç–∞–π–º–∞—É—Ç–æ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã
timeout 10s go run cmd/agent/main.go
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

- `main.go` - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ graceful shutdown
- `internal/agent/agent.go` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–≥–µ–Ω—Ç–∞
- `internal/agent/metrics.go` - —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
- `internal/agent/agent_test.go` - unit —Ç–µ—Å—Ç—ã

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

```mermaid
stateDiagram-v2
    [*] --> –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è --> –ó–∞–ø—É—Å–∫–ì–æ—Ä—É—Ç–∏–Ω
    –ó–∞–ø—É—Å–∫–ì–æ—Ä—É—Ç–∏–Ω --> –°–±–æ—Ä–ú–µ—Ç—Ä–∏–∫
    –ó–∞–ø—É—Å–∫–ì–æ—Ä—É—Ç–∏–Ω --> –û—Ç–ø—Ä–∞–≤–∫–∞–ú–µ—Ç—Ä–∏–∫
    
    –°–±–æ—Ä–ú–µ—Ç—Ä–∏–∫ --> –°–±–æ—Ä–ú–µ—Ç—Ä–∏–∫ : –∫–∞–∂–¥—ã–µ 2s
    –û—Ç–ø—Ä–∞–≤–∫–∞–ú–µ—Ç—Ä–∏–∫ --> –û—Ç–ø—Ä–∞–≤–∫–∞–ú–µ—Ç—Ä–∏–∫ : –∫–∞–∂–¥—ã–µ 10s
    
    –°–±–æ—Ä–ú–µ—Ç—Ä–∏–∫ --> GracefulShutdown : SIGINT/SIGTERM
    –û—Ç–ø—Ä–∞–≤–∫–∞–ú–µ—Ç—Ä–∏–∫ --> GracefulShutdown : SIGINT/SIGTERM
    
    GracefulShutdown --> –û—Å—Ç–∞–Ω–æ–≤–∫–∞–°–±–æ—Ä–∞
    GracefulShutdown --> –û—Å—Ç–∞–Ω–æ–≤–∫–∞–û—Ç–ø—Ä–∞–≤–∫–∏
    
    –û—Å—Ç–∞–Ω–æ–≤–∫–∞–°–±–æ—Ä–∞ --> –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    –û—Å—Ç–∞–Ω–æ–≤–∫–∞–û—Ç–ø—Ä–∞–≤–∫–∏ --> –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ --> [*]
    
    note right of –°–±–æ—Ä–ú–µ—Ç—Ä–∏–∫
        ‚Ä¢ runtime.MemStats
        ‚Ä¢ 29+ –º–µ—Ç—Ä–∏–∫
        ‚Ä¢ –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
    end note
    
    note right of –û—Ç–ø—Ä–∞–≤–∫–∞–ú–µ—Ç—Ä–∏–∫
        ‚Ä¢ HTTP POST
        ‚Ä¢ JSON —Ñ–æ—Ä–º–∞—Ç
        ‚Ä¢ Retry –ª–æ–≥–∏–∫–∞
    end note
```

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è** - —Å–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
2. **–ó–∞–ø—É—Å–∫ –≥–æ—Ä—É—Ç–∏–Ω** - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π —Å–±–æ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç—Ä–∏–∫
3. **–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫** - –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –∏–∑ `runtime.MemStats`
4. **–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç—Ä–∏–∫** - –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
5. **Graceful shutdown** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ —Å–∏–≥–Ω–∞–ª–∞—Ö

## üìä –ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤

```
2025/08/03 09:12:30 Starting metrics agent...
2025/08/03 09:12:32 Collected 29 metrics
2025/08/03 09:12:34 Collected 29 metrics
2025/08/03 09:12:36 Collected 29 metrics
2025/08/03 09:12:38 Collected 29 metrics
2025/08/03 09:12:40 Received signal: terminated
2025/08/03 09:12:40 Stopping agent...
2025/08/03 09:12:40 Agent stopped gracefully
```
